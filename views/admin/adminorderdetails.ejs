<%- include('../partials/adminheader.ejs') %>

    
    <style>
     
        .btn-edit {
            display: flex;
        }
    
        .actives {
            display: inline-block;
            padding: 2px 5px;
            background-color: green;
            color: white;
            border-radius: 3px;
        }
    
      
        .inactive {
            display: inline-block;
            padding: 2px 5px;
            background-color: red;
            color: white;
            border-radius: 3px;
        }
    
        .receipt-modal {
            text-align: center;
        }
    
        .receipt {
            text-align: left;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    
        #generateCodeContainer {
            display: inline-block;
            cursor: pointer;
           
            text-decoration: underline;
            
            font-weight: normal;
           
            background: none;
         
            border: none;
     
            padding: 0;
          
            margin: 0;
          
        }
    
        .custom-toast {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            
            display: none;
        }
    
        .toast-content {
            background-color: #f44336;
           
            color: #fff;
          
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            margin: 10px;
            max-width: 300px;
        }
    
        .toast-header {
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }
    
        .toast-title {
            font-weight: bold;
        }
    
        .toast-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
        }
    
        .toast-body {
            padding: 10px;
        }
    
        #notification-bar {
            display: none;
            position: fixed;
            z-index: 999;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 60px;
            display: flex;
            justify-content: center;
            
            align-items: center;
         
            background-color: #F4E0E1;
            color: #A42732;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }
    
        #notification-bar.visible {
            display: block;
            transform: translateX(-50%) translateY(20px);
            transition: transform 0.3s ease;
        }
    
        #notification-icon {
            width: 30px;
            
            height: 30px;
           
            margin-right: 10px;
        }
    
    
       
        .success-message {
            background-color: #A9DFBF;
            color: #196F3D;
        }
    
       
        .error-message {
            background-color: #F4E0E1;
            color: #A42732;
        }
    
        .message-box {
            position: fixed;
            top: 4%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    
        .success {
            background-color: #4CAF50;
        }
    
        .error {
            background-color: #f44336;
        }
    
      
        .message-icon {
            display: inline-block;
            margin-right: 5px;
        }
    </style>



<main class="main-wrap">
    <header class="main-header navbar">
        <div class="col-search">
            <!-- <form class="searchform">
                <div class="input-group">
                    <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                    <button class="btn btn-light bg" type="button"> <i class="material-icons md-search"></i></button>
                </div>
                <datalist id="search_terms">
                    <option value="Products">
                    <option value="New orders">
                    <option value="Apple iphone">
                    <option value="Ahmed Hassan">
                </datalist>
            </form> -->
        </div>
        <div class="col-nav">
            <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
            <ul class="nav">
                <li class="nav-item">
                    <a class="nav-link btn-icon" href="/admin/order?q=1">
                        <i class="material-icons md-notifications animation-shake"></i>
                        
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i> </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
                </li>
                <li class="dropdown nav-item">
                    <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownLanguage" aria-expanded="false"><i class="material-icons md-public"></i></a>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
                        <a class="dropdown-item text-brand" href="#"><img src="adminassets/imgs/theme/flag-us.png" alt="English">English</a>
                        <a class="dropdown-item" href="#"><img src="adminassets/imgs/theme/flag-fr.png" alt="Français">Français</a>
                        <a class="dropdown-item" href="#"><img src="adminassets/imgs/theme/flag-jp.png" alt="Français">日本語</a>
                        <a class="dropdown-item" href="#"><img src="adminassets/imgs/theme/flag-cn.png" alt="Français">中国人</a>
                    </div>
                </li>
                <li class="dropdown nav-item">
                    <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img class="img-xs rounded-circle" src="adminassets/imgs/people/avatar2.jpg" alt="User"></a>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                        <a class="dropdown-item" href="#"><i class="material-icons md-perm_identity"></i>Edit Profile</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account Settings</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-account_balance_wallet"></i>Wallet</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help center</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="/admin/logout"><i class="material-icons md-exit_to_app"></i>Logout</a>
                    </div>
                </li>
            </ul>
        </div>
    </header>

    <div
        class="d-flex ms-4 me-4 justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom my-4 ">
        <h3 class="h3">Order details</h3>
        <div class="btn-toolbar mb-2 mb-md-0">


        </div>
    </div>

   
    <div class="container content-wrapper-scroll">
        <div class="content-wrapper">
            <div class="row gutters bg-white">
               
                <div class="col-lg-12">
                    <div class="card-body">
                        <div class="row mt-20 order-info-wrap">
                            <div class="col-lg-10">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th width="40%">Product</th>
                                                <th width="20%">Unit Price</th>
                                                <th width="20%">Quantity</th>
                                                <th width="20%" class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                           
                                            <% 
                                             orders.items.forEach((item) => { %>
                                            <tr>
                                                <td>
                                                    <a class="itemside" href="#">
                                                        <div class="left">
                                                            <img src="/uploads/productImages/<%= item.image %>" width="40" height="40"
                                                                class="img-xs" alt="<%= item.name %>">
                                                        </div>
                                                        <div class="info"> <%= item.name %> </div>
                                                    </a>
                                                </td>
                                                <td> &#8377;<%= item.productPrice %></td>
                                                <td> <%= item.quantity %></td>
                                                <td class="text-end"> &#8377;<%= item.price %></td>
                                            </tr>

                                            <% }); %>
                                            <tr>
                                                <td colspan="4">
                                                    <article class="float-end">
                                                        <dl class="dlist">
                                                            <dt>Subtotal:</dt>
                                                            <dd>&#8377;<%= orders.billTotal %></dd>
                                                        </dl>
                                                        <dl class="dlist">
                                                            <dt>Grand total:</dt>
                                                            <dd> <b class="h5">&#8377;<%= orders.billTotal %></b> </dd>
                                                        </dl>
                                                        <dl class="dlist">
                                                            <dt class="text-muted">Payment Status:</dt>
                                                            <dd>
                                                                <span
                                                                    class="badge rounded-pill alert-success text-success"><%= orders.paymentStatus %></span>
                                                            </dd>
                                                        </dl>
                                                    </article>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>


             
                <div class="col-lg-4 col-md-12 col-sm-12 ">
                   
                    <div class="card ">
                        <div class="card-header" style="font-weight: bolder;">General Details</div>
                        <div class="card-body">
                            <form id="orderStatusForm" onsubmit="event.preventDefault(); submitOrderStatusForm('<%= orders.oId %>');">
    <label for="orderId" style="font-weight: bolder;">Order Id:</label><br>
    <%= orders.oId %><br /><br />
    <label for="orderDate" style="font-weight: bolder;">Order Date:</label><br>
    <input type="text" class="mt-2 mb-2 text-brand border-0" value="<%= orders.orderDate %>" disabled /><br>

    <label for="orderStatus" style="font-weight: bolder;">Order Status:</label><br>
    <select name="orderStatus" class="form-select mt-2" data-live-search="true">
        <% switch (orders.status) {
            case 'Pending': %>
        <option value="Pending" selected>Pending</option>
        <option value="Processing">Processing</option>
        <option value="Shipped">Shipped</option>
        <option value="Delivered">Delivered</option>
        <option value="Canceled">Canceled</option>
        <% break;
            case 'Processing': %>
        <option value="Processing" selected>Processing</option>
        <option value="Shipped">Shipped</option>
        <option value="Delivered">Delivered</option>
        <option value="Canceled">Canceled</option>
        <% break;
            case 'Shipped': %>
        <option value="Shipped" selected>Shipped</option>
        <option value="Delivered">Delivered</option>
        <option value="Canceled">Canceled</option>
        <% break;
            case 'Canceled': %>
        <option value="Canceled">Canceled</option>
        <% break;                                                  
            default: %>
        <option value="Delivered">Delivered</option>
        <% } %>
    </select><br>
    <button type="submit" class="btn btn-primary">Save Order</button>
</form>


                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" style="font-weight: bolder;">User Details</div>
                        <div class="card-body">
                            <strong style="font-weight: bold;"> Name:</strong>
                            <span class="text-brand"> <%= orders.user.name %></span><br>
                            <strong style="font-weight: bold;">Email:</strong>
                            <span class="text-brand"> <%= orders.user.email %></span><br>
                           
                            <strong style="font-weight: bold;">Blocked:</strong>
                            <span class="text-brand"><%=orders.user.isBlocked ? "Yes" : "No" %></span><br>
                            <strong style="font-weight: bold;">Mobile:</strong>
                            <span class="text-brand"> <%= orders.user.mobile %></span>

                        </div>
                    </div>





                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="card-header" style="font-weight: bolder;">User Requests</div>



                            <% if (orders && orders.request.length>0) { 
    if (orders.request[0].status === 'Pending') { %>
        <h6>Request for :<%= orders.request[0].type %></h6>
        <label for="reason">Reason:</label>
        <input type="text" value="<%= orders.request[0].reason %>" readonly class="mb-3 text-center">
        <br><br>
        <p>request status :<%= orders.request[0].status %></p>

        <button class="btn btn-success" onclick="acceptCancel('<%=orders.oId %>','<%=orders.user._id%>')">Accept</button>
        <button class="btn btn-danger" onclick="rejectCancel('<%=orders.oId %>')">Reject</button>
       
<% } else if (orders.status === 'Delivered' && orders.request[0].status === 'Pending') { %>
        <strong class="text-brand mb-3 mt-2 text-center">Order Returned <span style="font-size: 14px; color: black;">(Reason)</span></strong>
        <input type="text" value="<%= orders.request[0].reason %>" readonly class="mb-3 text-center border-0">
        <button class="btn btn-success w-50 mb-3 text-center ms-5 refund"  onclick="refundAmount('<%= orders._id %>','<%= orders.user._id %>')" >Accept Return Order</button>
<% } else { %>
        <!-- Display other request details as needed -->
        <% orders.request.forEach(request => { %>
            <% if (request.type === 'Return') { %>
                <div class="pt-3">Order return accepted</div>
                <span><a href="#" class="text-decoration-underline" target="_blank"></a> <i class="bi bi-box-arrow-up-right"></i></span>
            <% } %>
        <% }) %>
<% } %>
<% } else { %>
    <p class="h6 text-center">No requests available.</p>
<% } %>



                        </div>
                       
                    </div>
                    <hr>

                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                    <div class="card">

                        <div class="card-header" style="font-weight: bolder;">Shipping Details</div>
                        <div class="card-body">
                            <label for="Address" style="font-weight: bolder;">Address Type: </label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.addressType %></span><br>

                            <label for="HouseNo" style="font-weight: bolder;">House Number:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.HouseNo %></span><br>

                            <label for="Street" style="font-weight: bolder;">Street:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.Street %></span><br>

                            <label for="Landmark" style="font-weight: bolder;">Landmark:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.Landmark %></span><br>

                            <label for="Pincode" style="font-weight: bolder;">Pincode:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.pincode %></span><br>

                            <label for="City" style="font-weight: bolder;">City:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.city %></span><br>

                            <label for="District" style="font-weight: bolder;">District:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.district %></span><br>

                            <label for="State" style="font-weight: bolder;">State:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.State %></span><br>

                            <label for="Country" style="font-weight: bolder;">Country:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.Country %></span><br>
                        </div>
                    </div>


                   
                    <div class="card">
                        <div class="card-header" style="font-weight: bolder;">Payment Details</div>
                        <div class="card-body">
                            <label for="BillTotal" style="font-weight: bolder;">Bill Total:</label>
                            <span class="text-brand"> INR <%= orders.billTotal %></span><br>

                            <label for="PaymentMethod" style="font-weight: bolder;">Payment Method:</label>
                            <span class="text-brand"><%= orders.paymentMethod %></span><br>

                            <label for="PaymentStatus" style="font-weight: bolder;">Payment Status:</label>
                            <span class="text-brand"><%= orders.paymentStatus %></span><br>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script>
       
        document.addEventListener("DOMContentLoaded", function() {
        // Define the submitOrderStatusForm function in the global scope
        window.submitOrderStatusForm = function(orderId) {
            const newStatus = document.querySelector('select[name="orderStatus"]').value;
            console.log('Order ID:', orderId);
            console.log('New Status:', newStatus);

            Swal.fire({
                title: 'Are you sure?',
                text: "You are about to change the status.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, change it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/updateorderstatus', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            newStatus,
                            orderId
                        }),
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Order Status Updated',
                                text: 'The order status has been updated successfully.',
                            }).then(()=>{
                                window.location.reload()
                            })
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error Updating Order Status',
                                text: data.message || 'An error occurred while updating the order status.',
                            });
                        }
                    })
                    .catch((error) => {
                        console.error('Fetch Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Fetch Error',
                            text: 'An error occurred while making the request.',
                        });
                    });
                }
            });
        }
    });



    
    function acceptCancel(orderId, userId) {
 
    Swal.fire({
        title: 'Are you sure?',
        text: "You are about to accept the  request.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, accept it!'
    }).then((result) => {
      
        if (result.isConfirmed) {
          
            fetch('/admin/acceptCancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId,
                    userId
                }),
            })
            .then((response) => {
                if (response.ok) { 
                    Swal.fire({
                        icon: 'success',
                        title: 'Request Accepted',
                        text: 'The user request has been accepted.',
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error Updating Request',
                        text: data.message || 'An error occurred while updating the user request.',
                    });
                }
        })
            .catch((error) => {
                console.error('Fetch Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Fetch Error',
                    text: 'An error occurred while making the request.',
                });
            });
        }
    });
}




// function refundAmount(orderId, userId) {
           
//             const requestData = {
//                 orderId: orderId,
//                 userId: userId,
//             };
            
//             fetch('/admin/refund', {
//                     method: 'POST',
//                     headers: {
//                         'Content-Type': 'application/json',
//                     },
//                     body: JSON.stringify(requestData),
//                 })
//                 .then(response => {
                  
//                     console.log("Response status:", response.status);
//                     return response.json();
//                 })
//                 .then(data => {
                   
//                     console.log(data); 

//                     Swal.fire({
//                         icon: 'success',
//                         title: 'Amount refunded to user successfully',
//                         text: 'The order status has been updated successfully.',
//                     })
                   
//                     setTimeout(() => {
//                         window.location.reload()
//                     }, 1000)
                    
//                 })
//                 .catch(error => {
                   
//                     console.error('Error:', error);

//                     Swal.fire({
//                         icon: 'Error!',
//                         title: 'Failed to refund amount',
//                         text: error,
//                     });

//                 }) 
//         }

    function rejectCancel(orderId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You are about to reject the request.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, reject it!'
    }).then((result) => {
        if (result.isConfirmed) {
            return fetch('/admin/rejectCancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId
                }),
            });
        } else {
            
            throw new Error('Cancel rejection aborted by the user.');
        }
    })
    .then((response) => {
        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }
        return response.json();
    })
    .then((data) => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Request Rejected',
                text: 'User request has been rejected.',
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error Updating Request',
                text: data.message || 'An error occurred while updating the user request.',
            });
        }
    })
    .catch((error) => {
        
        if (error.message !== 'Cancel rejection aborted by the user.') {
            console.error('Fetch Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.',
            });
        }
    });
}


    </script>

    <footer class="main-footer font-xs">
   <div class="row pb-30 pt-15">
       <div class="col-sm-6">
           <script>
           document.write(new Date().getFullYear())
           </script> © <a href="/">Nyra</a>.
       </div>
       <div class="col-sm-6">
           <div class="text-sm-end">
               All rights reserved
           </div>
       </div>
   </div>
</footer>
</main>
    <script src="adminassets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="adminassets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="adminassets/js/vendors/select2.min.js"></script>
    <script src="adminassets/js/vendors/perfect-scrollbar.js"></script>
    <script src="adminassets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="adminassets/js/vendors/chart.js"></script>
    <!-- Main Script -->
    <script src="adminassets/js/main.js" type="text/javascript"></script>
    <script src="adminassets/js/custom-chart.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>

</html>